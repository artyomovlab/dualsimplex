---
title: "DualSimplex deconvolution pipeline, run on liver brain and lung data"
output: html_document
---

# WARNING: it's an old version without dso, and some things might not work

# Install DualSimplex package
```{r}
devtools::load_all("../../")
```


# Set necessary parameters for deconvolution
```{r}
n_ct <- 3
map_probes_to_genes <- TRUE
remove_pure_samples <- TRUE
```


# Load and clean data
```{r}
data_raw <- 2^readRDS("../../data/gse19830_exprs.rds")
true_basis <- 2^readRDS("../../data/gse19830_basis.rds")
true_proportions <- readRDS("../../data/gse19830_coef.rds")
```

```{r}
if (map_probes_to_genes) {
  probe_mapping <- biomaRt::select(rat2302.db::rat2302.db, rownames(data_raw), c("SYMBOL"))
  probe_mapping <- probe_mapping[probe_mapping$PROBEID %in% rownames(data_raw), ]
  probe_mapping <- probe_mapping[!duplicated(probe_mapping$SYMBOL), ]
  probe_mapping <- probe_mapping[!duplicated(probe_mapping$PROBEID), ]
  probe_mapping <- probe_mapping[!is.na(probe_mapping$SYMBOL), ]
  rownames(probe_mapping) <- probe_mapping$PROBEID

  data_raw <- data_raw[rownames(data_raw) %in% rownames(probe_mapping), ]
  true_basis <- true_basis[rownames(true_basis) %in% rownames(probe_mapping), ]

  rownames(data_raw) <- probe_mapping[rownames(data_raw), "SYMBOL"]
  rownames(true_basis) <- probe_mapping[rownames(true_basis), "SYMBOL"]
}

if (remove_pure_samples) {
  sample_is_mixed <- apply(true_proportions, 2, mad) != 0
  true_proportions <- true_proportions[, sample_is_mixed]
  data_raw <- data_raw[, sample_is_mixed]
}

dim(data_raw)
```


# Initial filtering
```{r}
data_anno <- annotate_data(data_raw, n_ct)
```

```{r}
describe_cat_features(data_anno)
```

```{r, fig.width=7, fig.height=3}
cowplot::plot_grid(plotlist = plot_numeric_features(data_anno, col_by = "LOC"), ncol = 4)
```

```{r}
plot_data_anno(data_anno, col_by_feature_genes = "plane_distance", col_by_feature_samples = "plane_distance")
```

```{r}
data_anno <- apply_default_filters(data_anno, keep_n_genes = 12000)
plot_data_anno(data_anno, col_by_feature_genes = "plane_distance", col_by_feature_samples = "plane_distance")
```

```{r}
data_anno <- threshold_filter(data_anno, "plane_distance", 0.03)
plot_data_anno(data_anno, col_by_feature_genes = "plane_distance", col_by_feature_samples = "plane_distance")
```

```{r, fig.width=7, fig.height=3}
cowplot::plot_grid(plotlist = plot_numeric_features(data_anno, genes = T), ncol = 4)
```


# Scaling and projection
```{r}
scaling <- sinkhorn_scale(data_anno$data)
set.seed(42)
projection <- svd_project(scaling, 1:3)
```

```{r}
plot_data_proj(projection$data_proj)
```


# Solution
```{r}
set.seed(42)
solution_proj <- initialize_solution(projection, "select_x")
plot_data_proj(projection$data_proj, solution_proj)
```


```{r}
solution_proj <- optimize_solution(scaling, projection, solution_proj, iterations = 10000)
plot_errors(solution_proj)
plot_data_proj(projection$data_proj, solution_proj)
plot_solution_history(projection, solution_proj, 100)
```

```{r}
plot_solution_history_anim(projection, solution_proj, 100, gif_filename = "optim_history_lbl.gif")
```

![Optimization GIF](optim_history_lbl.gif)


# Returning to original space and analysing solutions
```{r}
solution_scaled <- reverse_solution_projection(solution_proj, projection)
solution <- reverse_sinkhorn(
  H_row = solution_scaled$H_row,
  W_col = solution_scaled$W_col,
  scaling = scaling
)
```


# Comparing with true data
```{r}
ptb <- coerce_pred_true_basis(solution$W, true_basis[rownames(solution$W), ])
ptp <- coerce_pred_true_props(solution$H, true_proportions)
```

```{r fig.width=15, fig.height=5}
plot_ptp_scatter(ptp)
plot_ptb_scatter(ptb)
```

```{r}
plot_ptp_lines(ptp = ptp)
```

