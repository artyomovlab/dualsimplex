---
title: "Linseed 2 deconvolution pipeline, run on simulated data"
output:
  html_document
---


# Preparation
## Install Linseed 2 package
```{r}
unloadNamespace("linseed2")
devtools::load_all()
```

## Load and preprocess data
```{r}
data_raw <- as.matrix(readRDS("../../../datasets/GTEX_LUNG/gene_counts.Rda"))
data_raw <- remove_zero_rows(data_raw)
data_raw <- linearize_dataset(data_raw)
```


# Linseed 2 deconvolution

## Create Linseed 2 object
```{r}
save_dir <- "./linseed2_save_gtex_lung_11kg_8ct"
```

```{r}
# Fresh object (for the first run)
lo2 <- Linseed2Solver$new()
lo2$set_save_dir(save_dir)
```

```{r}
# Load from checkpoint option (to continue a previous run)
lo2 <- Linseed2Solver$from_state(save_dir, save_there = T)
```

## Set data
```{r}
# To calculate this step faster, reduce the dataset size to 10-20k genes
lo2$set_data(data_raw, gene_anno_lists = list(
  HK = read_gene_list("../../../datasets/gene_annotation_lists/HK.txt"),
  CC = read_gene_list("../../../datasets/gene_annotation_lists/CC.txt"),
  CODING = read_gene_list("../../../datasets/gene_annotation_lists/CODING_ENSEMBL.txt")
))
lo2$plot_svd()
```


## Apply simple filters
```{r, fig.height=4, fig.width=6}
lo2$plot_mad()
```

```{r}
colnames(fData(lo2$get_data()))
```

```{r}
lo2$basic_filter(
  log_mad_gt = 1, remove_true_cols_additional = c("RRNA"), keep_true_cols = c("CODING")
)
lo2$plot_mad()
lo2$plot_svd()
```

```{r}
lo2$get_filtering_stats()
```

## Calculate the projection onto solution plane, filter outliers and noise
```{r}
lo2$plot_svd(NULL)
lo2$project(8)
# all_dims <- list(2:3, 4:5, 6:7)
all_dims <- list(2:3, 3:4, c(2, 4), c(2, 5), c(2, 6), c(2, 7), c(2, 8))
```

```{r fig.width = 12, fig.height = 5}
lo2$plot_projected("zero_distance", "zero_distance", use_dims = all_dims)
lo2$plot_projected("plane_distance", "plane_distance", use_dims = all_dims)
lo2$plot_distances_distribution()
```

```{r}
# Uncomment
# lo2$distance_filter(plane_d_lt = 0.05, zero_d_lt = NULL, genes = T)
```

```{r}
lo2$get_filtering_stats()
```

Circle back to projection and iterate, until satisfied

```{r}
# Checkpoint
lo2$save_state()
```


## Choose visualization parameters for further analysis with filtered data
```{r fig.width = 12, fig.height = 5}
# Choose neighbors parameters to generate the umap with different detail level
# TODO: maybe add angles to umap
lo2$run_umap(neighbors_X = 40, neighbors_Omega = 40)
lo2$plot_projected(use_dims = NULL)
```

```{r}
# Choose appropriate visualization for further analysis
display_dims <- list(NULL, 2:3, c(2, 4), c(2, 5))
lo2$set_display_dims(display_dims)
```

This is the output of plot_projected now
```{r fig.width = 12, fig.height = 5}
lo2$plot_projected()
```


```{r}
lo2$get_save_dir()
# Checkpoint
lo2$save_state()
```



## Perform deconvolution

### Find initial solution
```{r fig.height = 5, fig.width = 11}
set.seed(15)
lo2$init_solution("select_x")
lo2$plot_projected()
```



### Optimize the solution
```{r}
# Choose hinge_H according to the number of genes, samples and intuition
# Run this cell several times, until it converges
# If something went wrong, you can init again and start from scratch
# TODO: reset_to_iter function
# TODO: plot W, H and lr alongside errors
lo2$optim_solution(2000, optim_config(coef_hinge_H = 0.01, coef_hinge_W = 0.1))
lo2$plot_error_history()
```

```{r fig.height = 5, fig.width = 11}
lo2$plot_projected()
```

```{r fig.height = 5, fig.width = 11}
lo2$plot_projected(use_dims = all_dims)
```

```{r}
# More flexible visualizations are possible manually
plot_projection_points(lo2$st$proj, pt_opacity = 0.8, pt_size = 0.1) %>%
  add_solution(lo2$st$solution_proj, lo2$st$proj) %>%
  add_solution_history(lo2$st$solution_proj, lo2$st$proj, pt_size = 0.5, pt_opacity = 1, step = 20, colored = T)
```



### Get final solution in original space
```{r}
solution <- lo2$finalize_solution()
```

```{r}
lo2$save_state()
```


## Generating report

### Optionally load single cell dataset
```{r}
library(Seurat)
seurat_obj <- NULL
res <- load_ts_lung()
ts_lung <- res[[1]]
rm(res)
clusters <- unique(ts_lung$anno)
ts_lung$anno_2 <- plyr::mapvalues(
  ts_lung$anno,
  from = c(clusters),
  to = c("pneumocytes", "neutrophils", "other", "other", "other", "macrophages", "other", "other", "monocytes", "ciliated")
)
Idents(ts_lung) <- "anno"

seurat_obj <- ts_lung
rm(ts_lung)
```

```{r}
scanpy <- reticulate::import("scanpy")
madisson <- scanpy$read_h5ad("../../../single_cell/lung_5loc_sc_sn_cellxgene_allgenes_05122022.h5ad")
counts <- t(madisson$X)
colnames(counts) <-  madisson$obs_names$to_list()
rownames(counts) <-  madisson$var_names$to_list()
counts <- Matrix::Matrix(as.matrix(counts), sparse = T)

seurat_obj <- Seurat::CreateSeuratObject(counts)
seurat_obj <- Seurat::AddMetaData(seurat_obj, madisson$obs)

embedding <- madisson$obsm["X_umap"]
rownames(embedding) <- madisson$obs_names$to_list()
colnames(embedding) <- c("umap_1", "umap_2")
seurat_obj[["umap"]] <- Seurat::CreateDimReducObject(embedding, key = "umap_")

seurat_obj <- Seurat::NormalizeData(seurat_obj)

rm(counts)
rm(embedding)
rm(madisson)

SeuratDisk::Convert("../../../single_cell/lung_5loc_sc_sn_cellxgene_allgenes_05122022.h5ad", "h5seurat")
seurat_obj <- SeuratDisk::LoadH5Seurat("../../../single_cell/lung_5loc_sc_sn_cellxgene_allgenes_05122022.h5seurat")
seurat_obj <- Seurat::ReadH5AD()
sessionInfo()
```

### Generate summary
```{r}
# Where will it be saved?
lo2$get_save_dir()
```

```{r}
lo2$set_display_dims(list(2:3))
lo2$generate_summary(seurat_obj = seurat_obj, with_animated_optim = FALSE)
```


# Manual additional research and figure fine-tuning
```{r fig.height = 5, fig.width = 11}
lo2$plot_projected(with_legend = T)
```
```{r}
seurat_obj <- add_list_markers(seurat_obj, lo2$get_marker_genes())
lo2$get_marker_genes()$cell_type_1 %in% rownames(seurat_obj)
nrow(seurat_obj)
```




```{r fig.width=18, fig.height=11}
markers <- lo2$get_marker_genes()
annot <- sapply(gsub("_", " ", names(markers)), function(s) paste0(toupper(substring(s, 1,1)), substring(s, 2)))
annot <- paste(annot, c("Adventitial cells", "Endothelial subset 1", "Neutrophils and monocytes", "Pneumocytes male subset",
           "Ciliated lung cells", "Endothelial subset 2", "Pneumocytes female subset", "Macrophages"), sep = "\n")
seurat_obj <- add_list_markers(seurat_obj, markers)
plot_marker_enrichment(seurat_obj, names(markers), limits = c(0, 1.5), ggadd = function(plt, i) plt + NoAxes() + NoLegend() + ggtitle(annot[[i]]))
```

```{r fig.height=5, fig.width=9}
df <- t(lo2$get_solution()$H)
colnames(df) <- paste0("CT", 1:8)
df <- melt(df)
ggplot(df, aes(x = Var2, y = value)) + geom_boxplot()+ theme_minimal()+ xlab(NULL) + ylab(NULL) + ylim(c(0, 1)) +
  theme(axis.text.x=element_text(size = 20), axis.text.y = element_text(size = 20))
```

```{r fig.width=7, fig.height=5}
Seurat::DimPlot(seurat_obj, reduction = "umap") + ggtitle("Clusters") + scale_colour_manual(values = c(colors_m, "grey70", "grey50", "grey10")) + NoAxes() + ggtitle(NULL)
```

```{r}
lo2$plot_svd_history()
```

```{r fig.height = 5, fig.width = 11}
lo2$st$marker_genes <- get_signature_markers(lo2$st$solution$W, 20)
lo2$plot_projected("markers", use_dims = all_dims)
lo2$plot_projected("markers", use_dims = NULL)
```


```{r fig.height = 5, fig.width = 11}
markers <- c("LINC01343", "LCE1E", "AC017002.2", "UGT1A3", "LINC01385", "H2BFWT", "OR13D1", "KIRREL3-AS3", "KRT75", "OTX2", "HRH3", "KRTAP19-1", "KRTAP19-3", "KRTAP7-1", "KRTAP10-2", "MMP10", "KRT14", "KRT31", "LCE1C", "KRT5", "KRT15", "S100A7", "KRT6C", "S100A2", "KRT6A", "MMP1", "KRT37", "MMP13", "KRT33A", "COL17A1", "KRT17", "DLK2", "C10orf99", "DSG3", "ANXA8", "FGF19", "AC133785.1")
lo2$plot_projected(markers)
```
