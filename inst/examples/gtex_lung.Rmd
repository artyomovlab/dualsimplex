---
title: "Linseed 2 deconvolution pipeline, run on simulated data"
output: 
  html_document
---


# Preparation
## Install Linseed 2 package
```{r}
unloadNamespace("linseed2")
devtools::load_all()
```

## Load and preprocess data
```{r}
data_raw <- as.matrix(readRDS("../../../datasets/GTEX_LUNG/gene_counts.Rda"))
data_raw <- remove_zero_rows(data_raw)
data_raw <- linearize_dataset(data_raw)
```


# Linseed 2 deconvolution

## Create Linseed 2 object
```{r}
save_dir <- "./linseed2_save_gtex_lung_6kg_7ct"
```

```{r}
# Fresh object (for the first run)
lo2 <- Linseed2Solver$new()
lo2$set_save_dir(save_dir)
```

```{r}
# Load from checkpoint option (to continue a previous run)
lo2 <- Linseed2Solver$from_state(save_dir, save_there = T)
```


## Set data
```{r}
# To calculate this step faster, reduce the dataset size to 10-20k genes
lo2$set_data(data_raw, gene_anno_lists = list(
  HK = read_gene_list("../../../datasets/gene_annotation_lists/HK.txt"),
  CC = read_gene_list("../../../datasets/gene_annotation_lists/CC.txt"),
  CODING = read_gene_list("../../../datasets/gene_annotation_lists/CODING_ENSEMBL.txt")
))
lo2$plot_svd()
```


## Apply simple filters
```{r, fig.height=4, fig.width=6}
lo2$plot_mad()
```

```{r}
colnames(fData(lo2$get_data()))
```

```{r}
lo2$basic_filter(
  log_mad_gt = 1, remove_true_cols_additional = c("RRNA", "HK", "CC"), keep_true_cols = c("CODING")
)
lo2$plot_mad()
lo2$plot_svd()
```

```{r}
lo2$get_filtering_stats()
```

## Calculate the projection onto solution plane, filter outliers and noise
```{r}
# Estimate the number of cell types by SVD plot and project
lo2$plot_svd(NULL)
```


### Project and perform distance-based filtering
```{r}
lo2$project(7)
```

```{r fig.width = 12, fig.height = 5}
lo2$plot_svd(NULL)
lo2$plot_projected("zero_distance", "zero_distance", use_dims = list(2:3, 4:5, 6:7))
lo2$plot_projected("plane_distance", "plane_distance", use_dims = list(2:3, 4:5, 6:7))
lo2$plot_distances_distribution()
```

```{r}
lo2$distance_filter(plane_d_lt = 0.03, zero_d_lt = NULL, genes = T)
```

```{r}
lo2$get_filtering_stats()
```

Circle back to projection and iterate, until satisfied

## Choose visualization parameters for further analysis with filtered data
```{r fig.width = 12, fig.height = 5}
# Choose neighbors parameters to generate the umap with different detail level
# TODO: maybe add angles to umap
lo2$run_umap(neighbors_X = 8, neighbors_Omega = 8)
lo2$plot_projected(use_dims = NULL)
```

```{r}
# Using just umap for further analysis
lo2$set_display_dims(NULL)
```

This is the output of plot_projected now
```{r fig.width = 12, fig.height = 5}
lo2$plot_projected()
```

Checkpoint, just in case
```{r}
lo2$save_state()
```



## Perform deconvolution

### Find initial solution
```{r fig.height = 5, fig.width = 11}
lo2$init_solution("select_x")
lo2$plot_projected()
```



### Optimize the solution
```{r}
# Choose hinge_H according to the number of genes, samples and intuition
# Run this cell several times, until it converges
# If something went wrong, you can init again and start from scratch
# TODO: reset_to_iter function
# TODO: plot W, H and lr alongside errors
lo2$optim_solution(10000, optim_config(coef_hinge_H = 0.01, coef_hinge_W = 0.001, coef_der_X = 0.01, coef_der_Omega = 0.01))
lo2$plot_error_history()
```

```{r fig.height = 5, fig.width = 11}
# TODO: with_solution and with_history to accept subset
lo2$plot_projected(use_dims = NULL)
```

```{r fig.height = 5, fig.width = 11}
lo2$plot_projected(NULL, NULL, pt_opacity = 1, pt_size = 0.5, use_dims = list(NULL, 2:3, 4:5, 6:7))
```

```{r}
# More flexible visualizations are possible manually
plot_projection_points(lo2$st$proj, pt_opacity = 0.8, pt_size = 0.1) %>% 
  add_solution(lo2$st$solution_proj, lo2$st$proj) %>% 
  add_solution_history(lo2$st$solution_proj, lo2$st$proj, pt_size = 0.5, pt_opacity = 1, step = 20, colored = T)
```



### Get final solution in original space
```{r}
solution <- lo2$finalize_solution()
```

```{r}
lo2$save_state()
```


## Generating report

### Optionally load single cell dataset
```{r}
seurat_obj <- NULL
library(Seurat)
res <- load_ts_lung()
ts_lung <- res[[1]]
ts_lung_endo <- res[[2]]
rm(res)
clusters <- unique(ts_lung$anno)
ts_lung$anno_2 <- plyr::mapvalues(
  ts_lung$anno,
  from = c(clusters),
  to = c("pneumocytes", "neutrophils", "other", "other", "other", "macrophages", "other", "other", "monocytes", "ciliated")
)
Idents(ts_lung) <- "anno"

rm(ts_lung_endo)
seurat_obj <- ts_lung
rm(ts_lung)
```


### Generate summary
```{r}
# Where will it be saved?
lo2$get_save_dir()
```

```{r}
lo2$set_display_dims(NULL)
lo2$generate_summary(seurat_obj = seurat_obj, with_animated_optim = FALSE)
```


# Manual additional research and figure fine-tuning
```{r fig.width=20, fig.height=10}
plot_marker_enrichment(seurat_obj, names(lo2$get_marker_genes()), limits = c(0, 1))
```
```{r fig.width=15}
Seurat::DimPlot(
  seurat_obj,
  reduction = "umap",
  group.by = "free_annotation"
)
```

```{r fig.width=8, fig.height=7}
Seurat::DimPlot(
  seurat_obj,
  reduction = "umap",
  cells.highlight = list(
    `dendritic cell` = WhichCells(seurat_obj, expression = free_annotation == "dendritic cell")
  )
)
```


