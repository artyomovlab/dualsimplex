---
title: "Linseed 2 Solver Summary"
output:
  html_document:
    df_print: paged
    self_contained: yes
params:
  lo2: !r NULL
  with_animated_optim: !r FALSE
  seurat_obj: !r NULL
---

<style>
img {
  height: 300px;
  width: auto;
}

h4 {
  margin-top: 20px;
}
</style>

```{r}
if (is.null(lo2$st$data))
  stop("Nothing was calculated yet")
```

### Filtering history
```{r}
lo2$get_filtering_stats()
```

```{r}
lo2$plot_svd_history()
```

### Dataset
Note: For further calculations, the resulting filtered dataset is used
```{r results='asis'}
cat(nrow(lo2$get_data()), "genes x", ncol(lo2$get_data()), "samples")
```

```{r fig.width=7}
lo2$plot_svd(NULL) + ggtitle("SVD explained variance")
```

```{r, fig.height=4, fig.width=6}
lo2$plot_mad()
```


```{r}
if (is.null(lo2$st$n_cell_types)) {
  knitr::knit_exit()
}
```

### Projection
```{r results='asis'}
cat(lo2$st$n_cell_types, "cell types selected")
```

```{r fig.width = 12}
lo2$plot_projected("zero_distance", "zero_distance", with_legend = T, with_solution = F, with_history = F)
```

```{r fig.width = 12}
lo2$plot_projected("plane_distance", "plane_distance", with_legend = T, with_solution = F, with_history = F)
```

```{r fig.width=12, fig.height=3}
lo2$plot_distances_distribution()
```


```{r}
if (is.null(lo2$st$solution_proj)) {
  knitr::knit_exit()
}
has_optim = "optim_history" %in% names(lo2$st$solution_proj)
```

`r if (has_optim) {"### Optimization history"}`

```{r, eval=has_optim}
lo2$plot_error_history() + ggtitle("Error history")
```

```{r, eval=has_optim}
lo2$plot_projected(with_legend = F, with_solution = T, with_history = T)
```

```{r, eval=has_optim}
lo2$plot_projected(NULL, NULL, with_legend = F, with_solution = T, with_history = T)
```

```{r, eval=has_optim && with_animated_optim}
plot_solution_history_anim(
  lo2$st$proj,
  lo2$st$solution_proj,
  use_dims = NULL,
  gif_filename = "optim_umap.gif",
  gif_dir = lo2$get_save_dir(),
  nframes = 305 # TODO: calculate automatically
)

# TODO: Optimization result, umap
# ![Optimization GIF, umap](optim_gtex_lung_umap.gif)
```


```{r}
if (is.null(lo2$st$solution)) {
  knitr::knit_exit()
}
```


### Solution
```{r}
lo2$plot_projected(with_legend = F, with_solution = T, with_history = F)
```

```{r fig.height=3, fig.width=12}
lo2$plot_solution_distribution()
```

```{r}
# TODO: ggplot and function
boxplot(t(lo2$get_solution()$H))
```


### Cell types
Solution enrichment in genes and samples
```{r fig.height = 5, fig.width = 11}
for (ct in lo2$get_ct_names()) {
  show(lo2$plot_projected(
    ct,
    ct,
    use_dims = NULL,
    pt_opacity = 1,
    with_legend = T,
    with_solution = T,
    with_history = F
  ))
}
```

### Marker genes
```{r fig.height = 5, fig.width = 11}
lo2$plot_projected(color_genes = "markers", color_samples = NULL, with_solution = T, with_history = F)
```

```{r, results="asis"}
cat_markers(lo2$get_marker_genes())
```

```{r}
if (is.null(seurat_obj)) {
  knitr::knit_exit()
}
```

### Single cell enrichment
```{r}
Seurat::DimPlot(seurat_obj) + ggtitle("Clusters")
```

```{r}
plot_height <- (ceiling(lo2$get_n_cell_types() / 4) * 5)
```

```{r fig.width=20, fig.height=plot_height, message=FALSE, warning=FALSE, results='hide'}
seurat_obj <- add_list_markers(seurat_obj, lo2$get_marker_genes())
plot_marker_enrichment(seurat_obj, names(lo2$get_marker_genes()), limits = c(0, 1.5))
```


```{r}
# TODO: heatmaps
# TODO: gradient maps
# TODO: multiple inits
```

