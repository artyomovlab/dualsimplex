---
title: "Notebook to check your code changes before submitting PR"
---

# Perform package checks 

```{r}
library(devtools)
```
```{r}
Rcpp::compileAttributes(verbose = T)
```

## Documentation files will be generated
```{r}
devtools::document()
```

## A lot of different checks of your code

```{r}
devtools::check()
```

# Install from your branch
ensure you unloaded the package, removed the previous version and restarted the R session.
```{r}
devtools::install_github("artyomovlab/DualSimplex@theta_optimization_revised")
library(DualSimplex)
```

# Test run

## Create object
```{r fig.height = 5, fig.width = 11}
library(dplyr)

n_ct <- 3

set.seed(3)
sim <- create_simulation(n_genes = 10000,
                         n_samples = 100,
                         n_cell_types = n_ct,
                         with_marker_genes = FALSE)
sim <- sim %>% add_noise(noise_deviation = 0.2)

data_raw <- sim$data
true_basis <- sim$basis
true_proportions <- sim$proportions

dso <- DualSimplexSolver$new()
dso$set_data(data_raw)

plane_distance_threshold = 0.05 # Change here several times to see result, start with big and lower it
dso$project(3)
dso$distance_filter(plane_d_lt = plane_distance_threshold,
                    zero_d_lt = NULL,
                    genes = T)

dso$project(3)
dso$plot_svd_history()
dso$init_solution("random")
dso$plot_projected(
  "zero_distance",
  "zero_distance",
  with_solution = TRUE,
  use_dims = list(2:3)
)
```


## Make specific init, which was in a paper
```{r}
set.seed(23)
dso$init_solution("random")
dso$plot_projected(
  "plane_distance",
  "plane_distance",
  with_solution = TRUE,
  use_dims = list(2:3)
)
```


## Make 5000 steps of optimization
```{r}
blocks <- 5
iterations <- 5000


for (i in 1:blocks) {
  dso$optim_solution(
    round(iterations / blocks),
    optim_config(
      coef_hinge_H = 1,
      coef_hinge_W = 1,
      coef_der_X = 0.001,
      coef_der_Omega = 0.001
    )
  )
  curr_X <- dso$st$solution_proj$X  # this is how we can extract solution on a fly
  curr_Omega <- dso$st$solution_proj$Omega # this is how we can extract solution on a fly
}
```

```{r fig.height = 5, fig.width = 11}
dso$plot_projected(
  "zero_distance",
  "zero_distance",
  with_solution = TRUE,
  use_dims = list(2:3)
)
```

```{r}
dso$plot_error_history()
```


## Prepare basis/proportions plots
```{r}
solution <- dso$finalize_solution()
names(solution)
solution <- dso$get_solution()
```

```{r fig.width=20, fig.height=5}
ptb <- coerce_pred_true_basis(solution$W, true_basis[rownames(solution$W), ])
ptp <- coerce_pred_true_props(solution$H, true_proportions)
plot_ptp_scatter(ptp)
plot_ptb_scatter(ptb)
```

```{r}
plot_ptp_lines(ptp)
```


```{r}
extended_sinkhorn_scale2 <- function(
  V,
  W,
  H,
  n_iter
) {
  extended_scaling_result <- extended_sinkhorn(V, W, H, n_iter)
  V_row <- sinkhorn_sweep_c(
    V = V,
    D_vs_row = extended_scaling_result$D_vs_row,
    D_vs_col = extended_scaling_result$D_vs_col,
    iter = n_iter,
    do_last_step = 0
   )
  rownames(V_row) <- rownames(V)
  colnames(V_row) <- colnames(V)

  V_col <- sinkhorn_sweep_c(
  V = V,
  D_vs_row = extended_scaling_result$D_vs_row,
  D_vs_col = extended_scaling_result$D_vs_col,
  iter = n_iter,
  do_last_step = 1
  )
  rownames(V_col) <- rownames(V)
  colnames(V_col) <- colnames(V)

  H_row <- sinkhorn_sweep_c(
  V = H,
  D_vs_row = extended_scaling_result$D_hs_row,
  D_vs_col = extended_scaling_result$D_vs_col,
  iter = n_iter - 1,
  do_last_step = 0
 )
  rownames(H_row) <- rownames(H)
  colnames(H_row) <- colnames(H)

  H_col <- sinkhorn_sweep_c(
  V = H,
  D_vs_row = extended_scaling_result$D_hs_col,
  D_vs_col = extended_scaling_result$D_vs_col,
  iter = n_iter,
  do_last_step = 1
 )
  rownames(H_col) <- rownames(H)
  colnames(H_col) <- colnames(H)


  W_row <- sinkhorn_sweep_c(
  V = W,
  D_vs_row = extended_scaling_result$D_vs_row,
  D_vs_col = extended_scaling_result$D_ws_row,
  iter = n_iter,
  do_last_step = 1
 )
  rownames(H_row) <- rownames(H)
  colnames(H_row) <- colnames(H)


  W_col <- sinkhorn_sweep_c(
  V = W,
  D_vs_row = extended_scaling_result$D_vs_row,
  D_vs_col = extended_scaling_result$D_ws_col,
  iter = n_iter,
  do_last_step = 1
 )
  rownames(W_col) <- rownames(W)
  colnames(W_col) <- colnames(W)

  return(list(
    V_row = V_row,
    V_col = V_col,
    W_row = W_row,
    W_col = W_col,
    H_row = H_row,
    H_col = H_col,
    D_vs_row =  extended_scaling_result$D_vs_row,
    D_vs_col =  extended_scaling_result$D_vs_col,
    D_hs_row =  extended_scaling_result$D_hs_row,
    D_ws_col =  extended_scaling_result$D_hs_col,
    D_hs_col = extended_scaling_result$D_hs_col,
    D_ws_row = extended_scaling_result$D_ws_row
  ))
}
```




```{r}
extended_scaling_result <- extended_sinkhorn_scale2(V = data_raw, W=true_basis, H=true_proportions, n_iter = dso$st$scaling$iterations)
```


## Check true solution
```{r}
R <-  dso$st$proj$meta$R
S <-  dso$st$proj$meta$S
H_ss <-  extended_scaling_result$H_row
W_ss<-  extended_scaling_result$W_row
W_gs <-  extended_scaling_result$W_col
H_gs <-  extended_scaling_result$H_col

X_result <- H_ss %*% t(R)
Omega_result <- t(S %*% W_gs)
```
```{r}
dso$init_solution("random")
```
```{r fig.width=5, fig.height=5}
library(ggplot2)
res_plots <- dso$plot_projected(use_dims = 2:3, with_solution = T, with_history = F, wrap = F, show_plots = F) 
res_plots[[1]] + geom_point(
    data = X_result,
    color = "purple",
    pch = 22,
    size = 3
  ) 


res_plots[[2]] + geom_point(
    data = Omega_result,
    color = "purple",
    pch = 22,
    size = 3
  ) 
```


```{r}
V <- data_raw
W <-  true_basis
H <- true_proportions
extended_scaling_result <- extended_sinkhorn(V, W, H, dso$st$scaling$iterations)

```
```{r}
Rcpp::sourceCpp(file = "test_cpp.cpp")
```

```{r}
extended_scaling_result <- extended_sinkhorn(V, W, H, dso$st$scaling$iterations)

```

```{r}
extended_scaling_result$
```

